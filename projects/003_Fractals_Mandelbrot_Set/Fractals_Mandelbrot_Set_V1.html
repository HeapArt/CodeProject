<!DOCTYPE html>
<html>

<head>
  <script>

    var gGlobal = {
      CanvasId : "id_ViewPoint",
      Zoom : {
        offsetX : 0,
        offsetY : 0,
        scale : 0.01,
      },

      MaxIteration : 255,

      LastX : 0,
      LastY : 0,
      Jump: 500,

      ColorMap : [[0,0,0,1],[1,0,0,1],[1,1,0,1],[0,1,0,1],[0,1,1,1],[0,0,1,1],[1,0,1,1],[1,1,1,1]],

    }

    function getColor(iPercentage) {
      var wIndex = iPercentage * (gGlobal.ColorMap.length - 1);
      var wUpper = Math.ceil(wIndex);
      var wLower = Math.floor(wIndex);
      

      var wColor = [0,0,0,0];
      var wFraction = wIndex - wLower;

      for (var wi = 0; wi < wColor.length; ++wi) {
        wColor[wi] = wFraction*(gGlobal.ColorMap[wUpper][wi] - gGlobal.ColorMap[wLower][wi]) + gGlobal.ColorMap[wLower][wi];
        wColor[wi] *= 255;
        wColor[wi] = Math.round(wColor[wi]);
      }
      return wColor;
    }

    function drawMandelbrotSet( iCanvas, iZoom ) {
      if (null == iCanvas) {
        return;
      }

      var wCtx = iCanvas.getContext("2d");
      if (null == wCtx) {
        return;
      }

      var wCanvasWidth = iCanvas.width;
      var wCanvasHeight = iCanvas.height;

      var wImageData = wCtx.getImageData(0, 0, wCanvasWidth, wCanvasHeight);
      var wPixelData = wImageData.data;
      

      for (var wX = gGlobal.LastX, wCountX = 0; wX < wCanvasWidth && wCountX < gGlobal.Jump; ++ wX, ++wCountX) {
        for (var wY = gGlobal.LastY, wCountY = 0; wY < wCanvasHeight && wCountY < gGlobal.Jump; ++ wY, ++wCountY) {
          var wIndex = 4*(wY* wCanvasWidth + wX);

          var wColor = [0,0,0,255];

          var wRow = iZoom.scale*(wX - wCanvasWidth/2) + iZoom.offsetX;
          var wCol = iZoom.scale*(wY - wCanvasHeight/2) + iZoom.offsetY;

          var wCount = 0;
          var wReal = 0;
          var wImaginary = 0;

          for (wCount = 0; wCount < gGlobal.MaxIteration; ++wCount) {

              if (wReal*wReal + wImaginary*wImaginary > 4 ) {
                break;
              }
              var wReal_new = wReal*wReal - wImaginary*wImaginary + wRow;
              var wImaginary_new = 2*wReal*wImaginary + wCol; 

              wReal = wReal_new;
              wImaginary = wImaginary_new;


          }


            wColor = getColor(1 - wCount/gGlobal.MaxIteration);

          wPixelData[wIndex] = wColor[0];
          wPixelData[wIndex + 1] = wColor[1];
          wPixelData[wIndex + 2] = wColor[2];
          wPixelData[wIndex + 3] = wColor[3];
        }
      }


      wCtx.putImageData(wImageData, 0, 0);

      gGlobal.LastX += gGlobal.Jump;

      if (gGlobal.LastX >= wCanvasWidth) {
        gGlobal.LastX = 0;
        gGlobal.LastY += gGlobal.Jump;
        if (gGlobal.LastY >= wCanvasHeight) {
          gGlobal.LastX = 0;
          gGlobal.LastY = 0;

          return true;
        }
      }

      return false;

    }


    function animate() {
      window.requestAnimationFrame(animate);

      var wChanged = false;
      if (true == gGlobal.Redraw) {
        wChanged = true;
      }

      if (wChanged) {
        var wCanvas = document.getElementById(gGlobal.CanvasId);
        if (null != wCanvas) {
          drawMandelbrotSet(wCanvas, gGlobal.Zoom);
        }

       // gGlobal.Redraw = false;
      }
    }

    function resize() {

      var wCanvas = document.getElementById(gGlobal.CanvasId);
      if (null != wCanvas) {
        wCanvas.width = wCanvas.parentNode.offsetWidth;
        wCanvas.height = wCanvas.parentNode.offsetHeight;
      }

      gGlobal.Redraw = true;
    }

    function init () {
      resize();
      window.addEventListener("resize", resize);
      
      var wCanvas = document.getElementById(gGlobal.CanvasId);
      if (null != wCanvas) {
        var wLimitSide = wCanvas.width < wCanvas.height ?  wCanvas.width : wCanvas.height;
        gGlobal.Zoom.scale = 3/wLimitSide;
      
        wCanvas.addEventListener("wheel", function(e) {         
          gGlobal.Zoom.scale *=  Math.pow(1.001, e.deltaY);
          gGlobal.Redraw = true;
        });

        
        wCanvas.addEventListener("mousedown", function (e) {
           gGlobal.Zoom.offsetX += gGlobal.Zoom.scale *(e.x - wCanvas.width/2);
           gGlobal.Zoom.offsetY += gGlobal.Zoom.scale *(e.y - wCanvas.height/2);
           
           gGlobal.Redraw = true;

        });
      }

      gGlobal.Redraw = true;
      animate();
    }

    window.addEventListener("load", init);

  </script>
  <style>
    body {
      margin: 0px;
      padding: 0px;
      height: 100vh;
      width: 100%;
    }

    #id_ViewPoint_div {
      width: 100%;
      height: 100%;
    }

  </style>
</head>
<body>
  <div id="id_ViewPoint_div">
    <canvas id="id_ViewPoint"></canvas>
  </div>
</body>
</html>