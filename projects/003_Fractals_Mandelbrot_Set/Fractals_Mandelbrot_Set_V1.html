<!DOCTYPE html>
<html>

<head>
  <script>

    var gGlobal = {
      CanvasId : "id_ViewPoint",
      Zoom : {
        offsetX : 0,
        offsetY : 0,
        scale : 0.01,
      },

      MaxIteration : 1000,

      LastX : 0,
      LastY : 0,
      Jump: 500,
      Intervals : 10,

      ColorMap : [[0,0,0,1],[1,0,0,1],[1,1,0,1],[0,1,0,1],[0,1,1,1],[0,0,1,1],[1,0,1,1],[1,1,1,1]],

      DrawState : 0
    }

    function getColor(iPercentage) {
      var wIndex = iPercentage * (gGlobal.ColorMap.length - 1);
      var wUpper = Math.ceil(wIndex);
      var wLower = Math.floor(wIndex);
      

      var wColor = [0,0,0,0];
      var wFraction = wIndex - wLower;

      for (var wi = 0; wi < wColor.length; ++wi) {
        wColor[wi] = wFraction*(gGlobal.ColorMap[wUpper][wi] - gGlobal.ColorMap[wLower][wi]) + gGlobal.ColorMap[wLower][wi];
        wColor[wi] *= 255;
        wColor[wi] = Math.round(wColor[wi]);
      }
      return wColor;
    }

    function drawMandelbrotSet( iCanvas, iZoom ) {
      if (null == iCanvas) {
        return;
      }

      var wCtx = iCanvas.getContext("2d");
      if (null == wCtx) {
        return;
      }

      var wCanvasWidth = iCanvas.width;
      var wCanvasHeight = iCanvas.height;

      var wImageData = wCtx.getImageData(0, 0, wCanvasWidth, wCanvasHeight);
      var wPixelData = wImageData.data;
      

      for (var wX = gGlobal.LastX, wCountX = 0; wX < wCanvasWidth && wCountX < gGlobal.Jump; ++ wX, ++wCountX) {
        for (var wY = gGlobal.LastY, wCountY = 0; wY < wCanvasHeight && wCountY < gGlobal.Jump; ++ wY, ++wCountY) {
          var wIndex = 4*(wY* wCanvasWidth + wX);

          var wColor = [0,0,0,255];

          var wRow = iZoom.scale*(wX - wCanvasWidth/2) + iZoom.offsetX;
          var wCol = iZoom.scale*(wY - wCanvasHeight/2) + iZoom.offsetY;

          var wCount = 0;
          var wReal = 0;
          var wImaginary = 0;

          for (wCount = 0; wCount < gGlobal.MaxIteration; ++wCount) {

              if (wReal*wReal + wImaginary*wImaginary > 4 ) {
                break;
              }
              var wReal_new = wReal*wReal - wImaginary*wImaginary + wRow;
              var wImaginary_new = 2*wReal*wImaginary + wCol; 

              wReal = wReal_new;
              wImaginary = wImaginary_new;


          }


          wColor = getColor(1 - wCount/gGlobal.MaxIteration);

          wPixelData[wIndex] = wColor[0];
          wPixelData[wIndex + 1] = wColor[1];
          wPixelData[wIndex + 2] = wColor[2];
          wPixelData[wIndex + 3] = wColor[3];
        }
      }


      wCtx.putImageData(wImageData, 0, 0);

      gGlobal.LastX += gGlobal.Jump;

      if (gGlobal.LastX >= wCanvasWidth) {
        gGlobal.LastX = 0;
        gGlobal.LastY += gGlobal.Jump;
        if (gGlobal.LastY >= wCanvasHeight) {
          gGlobal.LastX = 0;
          gGlobal.LastY = 0;

          return true;
        }
      }

      return false;

    }

    function TransFormImage(dx,dy, dScale) {
      var wCanvas = document.getElementById(gGlobal.CanvasId);
      if (null == wCanvas) {
        return;
      }

      var wMainCtx = wCanvas.getContext("2d");
      if (null == wMainCtx) {
        return;
      }

      var wTempCanvas = document.createElement("canvas");
      wTempCanvas.width = wCanvas.width;
      wTempCanvas.height = wCanvas.height;
      var wTempCtx = wTempCanvas.getContext("2d");

      wTempCtx.drawImage(wCanvas, dx,dy);

      wMainCtx.clearRect(0,0,wCanvas.width, wCanvas.height);
      wMainCtx.drawImage(wTempCanvas,0,0,dScale*wCanvas.width, dScale*wCanvas.height);

    }

    function animate() {
      window.requestAnimationFrame(animate);

      var wChanged = false;
      if (true == gGlobal.Redraw) {
        gGlobal.DrawState = 0;
        gGlobal.LastX = 0;
        gGlobal.LastY = 0;
        gGlobal.Redraw = false;
      }

      if (0 == gGlobal.DrawState) {
        
        var wCanvas = document.getElementById(gGlobal.CanvasId);
        if (null != wCanvas) {
          if (true == drawMandelbrotSet(wCanvas, gGlobal.Zoom)){
            gGlobal.DrawState = 1;
          }
        }
        else {
          gGlobal.DrawState = 1;
        }
      }
    }

    function resize() {

      var wCanvas = document.getElementById(gGlobal.CanvasId);
      if (null != wCanvas) {
        wCanvas.width = wCanvas.parentNode.offsetWidth;
        wCanvas.height = wCanvas.parentNode.offsetHeight;

        var wLargerSide = wCanvas.width > wCanvas.height ? wCanvas.width : wCanvas.height;

        gGlobal.Jump = Math.round(wLargerSide / gGlobal.Intervals);
      }

      gGlobal.Redraw = true;
    }

    function init () {
      resize();
      window.addEventListener("resize", resize);
      
      var wCanvas = document.getElementById(gGlobal.CanvasId);
      if (null != wCanvas) {
        var wLimitSide = wCanvas.width < wCanvas.height ?  wCanvas.width : wCanvas.height;
        gGlobal.Zoom.scale = 3/wLimitSide;
      
        wCanvas.addEventListener("wheel", function(e) {
          var wScale = Math.pow(1.001, e.deltaY)
          gGlobal.Zoom.scale *= wScale;
          gGlobal.Redraw = true;
          
          var wCanvas = document.getElementById(gGlobal.CanvasId);
          if (null != wCanvas) {
            
            var wDx = Math.round((wScale - 1 )*wCanvas.width/2);
            var wDy = Math.round((wScale - 1 )*wCanvas.height/2);
            TransFormImage(wDx,wDy,1/wScale );
          }
        });

        
        wCanvas.addEventListener("mousedown", function (e) {
           var wDx = e.x - wCanvas.width/2;
           var wDy = e.y - wCanvas.height/2;
           gGlobal.Zoom.offsetX += gGlobal.Zoom.scale *wDx;
           gGlobal.Zoom.offsetY += gGlobal.Zoom.scale *wDy;
           
           gGlobal.Redraw = true;
           TransFormImage(-wDx, -wDy,1);

        });
      }

      gGlobal.Redraw = true;
      animate();
    }

    window.addEventListener("load", init);

  </script>
  <style>
    body {
      margin: 0px;
      padding: 0px;
      height: 100vh;
      width: 100%;
    }

    #id_ViewPoint_div {
      width: 100%;
      height: 100%;
    }

  </style>
</head>
<body>
  <div id="id_ViewPoint_div">
    <canvas id="id_ViewPoint"></canvas>
  </div>
</body>
</html>