<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Transfer Function Image</title>

  <script>
  </script>
  <script>
    var gGlobal = {
      ImageFileInputId: "id_Input_ImgFile",
      ImageFileLoadButtonId: "id_Input_ImgFile_load_btn",
      ViewCanvasId: "id_ViewPoint",
      HiddenCanvas: document.createElement("canvas"),
      ReferenceImage: document.createElement("img"),
      ReferenceImageAvailable: false,
      mouseHandler: {
        x: -1,
        y: -1
      },

      offsetArrayX: null,
      offsetArrayY: null,
      velocityArrayX: null,
      velocityArrayY: null,
      lastIterationTime : 0
    };

    function transferFunction(iX, iY) {

      var wDx = iX - gGlobal.mouseHandler.x;
      var wDy = iY - gGlobal.mouseHandler.y;
      var wRadSq = wDx * wDx + wDy * wDy;

      return {
        x: iX + Math.round(10 / wDx),
        y: iY + Math.round(10 / wDy)
      };

      return {
        x: iX,
        y: iY
      };

    }

    function init() {
      resize();
      window.addEventListener("resize", resize);

      var wLoadButton = document.getElementById(gGlobal.ImageFileLoadButtonId);
      if (null != wLoadButton) {
        wLoadButton.addEventListener("click", function () {
          var wInputFile = document.getElementById(gGlobal.ImageFileInputId);
          if (null != wInputFile) {
            if (wInputFile.files && wInputFile.files[0]) {
              gGlobal.ReferenceImage.src = URL.createObjectURL(wInputFile.files[0]);
            }
          }
        })
      }

      gGlobal.ReferenceImage.onload = function () {
        gGlobal.ReferenceImageAvailable = true;
      }

      var wViewPointCanvas = document.getElementById(gGlobal.ViewCanvasId);
      if (null != wViewPointCanvas) {
        wViewPointCanvas.addEventListener("mousemove", function (iEvent) {
          gGlobal.mouseHandler.x = iEvent.x;
          gGlobal.mouseHandler.y = iEvent.y;

        })
      }

      gGlobal.lastIterationTime = (new Date).getTime();
      gameLoop();
    }

    function gameLoop() {

      var wTime = (new Date).getTime();
      var wDt = wTime - gGlobal.lastIterationTime;
      wDt /= 1000;

      gGlobal.lastIterationTime = wTime;


      var wViewPointCanvas = document.getElementById(gGlobal.ViewCanvasId);
      if (null == wViewPointCanvas) {
        return;
      }

      var wCanvasWidth = wViewPointCanvas.width;
      var wCanvasHeight = wViewPointCanvas.height;

      if (true == gGlobal.ReferenceImageAvailable) {

        var wScaleW = gGlobal.ReferenceImage.width / wCanvasWidth;
        var wScaleH = gGlobal.ReferenceImage.height / wCanvasHeight;

        var wScale = wScaleW > wScaleH ? wScaleW : wScaleH;
        wScale = 1 / wScale;


        var wXOffset = (wCanvasWidth - wScale * gGlobal.ReferenceImage.width) / 2.0;
        var wYOffset = (wCanvasHeight - wScale * gGlobal.ReferenceImage.height) / 2.0;

        var wHiddenImgCtx = gGlobal.HiddenCanvas.getContext("2d");
        wHiddenImgCtx.clearRect(0, 0, wCanvasWidth, wCanvasHeight);
        wHiddenImgCtx.drawImage(gGlobal.ReferenceImage, wXOffset, wYOffset, wScale * gGlobal.ReferenceImage.width, wScale * gGlobal.ReferenceImage.height);

        var wHiddenImgData = wHiddenImgCtx.getImageData(0, 0, wCanvasWidth, wCanvasHeight);
        var wHiddenImgPixelArray = wHiddenImgData.data;


        var wViewImgCtx = wViewPointCanvas.getContext("2d");
        wViewImgCtx.clearRect(0, 0, wCanvasWidth, wCanvasHeight);

        var wViewImgData = wViewImgCtx.getImageData(0, 0, wCanvasWidth, wCanvasHeight);
        var wViewImgPixelArray = wViewImgData.data;

        var wK = 1000;
        var wC = 750;
        var wQ = 10000000;
        var wRadLimit = 1000;
        var wRadLimitSq = wRadLimit * wRadLimit;

        for (var wi = 0; wi < gGlobal.offsetArrayX.length; ++wi) {
          var wX = wi % wCanvasWidth;
          var wY = Math.floor(wi / wCanvasWidth);
          var wDx = wX + gGlobal.offsetArrayX[wi] - gGlobal.mouseHandler.x;
          var wDy = wY + gGlobal.offsetArrayY[wi] - gGlobal.mouseHandler.y;

          var wFx = - wK * gGlobal.offsetArrayX[wi] - wC * gGlobal.velocityArrayX[wi];
          var wFy = - wK * gGlobal.offsetArrayY[wi] - wC * gGlobal.velocityArrayY[wi];

          var wRadSq = wDx * wDx + wDy * wDy;
          if (wRadSq < wRadLimitSq) {

            var wFMag = wQ / (wRadSq);
            var wRad = Math.sqrt(wRadSq);
            wFx += wFMag * wDx / wRad;
            wFy += wFMag * wDy / wRad;
          }
          
          var wMappedIndex = wi * 4;
          var wMass = 0;
          wMass += wHiddenImgPixelArray[wMappedIndex];
          wMass += wHiddenImgPixelArray[wMappedIndex + 1];
          wMass += wHiddenImgPixelArray[wMappedIndex + 2];
          wMass /=3;
          wMass += 100;

          gGlobal.velocityArrayX[wi] += wDt * wFx / wMass;
          gGlobal.velocityArrayY[wi] += wDt * wFy / wMass;

          gGlobal.offsetArrayX[wi] += wDt * gGlobal.velocityArrayX[wi];
          gGlobal.offsetArrayY[wi] += wDt * gGlobal.velocityArrayY[wi];
        }

        for (var wi = 0; wi < gGlobal.offsetArrayX.length; ++wi) {

          if ((0 == Math.round(gGlobal.offsetArrayX[wi])) && (0 == Math.round(gGlobal.offsetArrayY[wi]))) {
            var wMappedIndex = wi * 4;
            wViewImgPixelArray[wMappedIndex] = wHiddenImgPixelArray[wMappedIndex];
            wViewImgPixelArray[wMappedIndex + 1] = wHiddenImgPixelArray[wMappedIndex + 1];
            wViewImgPixelArray[wMappedIndex + 2] = wHiddenImgPixelArray[wMappedIndex + 2];
            wViewImgPixelArray[wMappedIndex + 3] = wHiddenImgPixelArray[wMappedIndex + 3];

          }
        }

        for (var wi = 0; wi < gGlobal.offsetArrayX.length; ++wi) {

          var wDx = Math.round(gGlobal.offsetArrayX[wi]);
          var wDy = Math.round(gGlobal.offsetArrayY[wi]);

          if ((0 != wDx) || (0 != wDy)) {

            var wX = wi % wCanvasWidth;
            wX += wDx;

            var wY = Math.floor(wi / wCanvasWidth);
            wY += wDy;

            if ((wX >= 0) && (wX < wCanvasWidth)) {
              if ((wY >= 0) && (wY < wCanvasHeight)) {
                var wNewIndex = wY * wCanvasWidth + wX;
                wNewIndex *= 4;
                wOldIndex = wi * 4;

                wViewImgPixelArray[wNewIndex] = wHiddenImgPixelArray[wOldIndex];
                wViewImgPixelArray[wNewIndex + 1] = wHiddenImgPixelArray[wOldIndex + 1];
                wViewImgPixelArray[wNewIndex + 2] = wHiddenImgPixelArray[wOldIndex + 2];
                wViewImgPixelArray[wNewIndex + 3] = wHiddenImgPixelArray[wOldIndex + 3];

              }
            }
          }

        }

        wViewImgCtx.putImageData(wViewImgData, 0, 0);

      }


      requestAnimationFrame(gameLoop);
    }

    function resize() {
      var wViewCanvas = document.getElementById(gGlobal.ViewCanvasId);
      if (null != wViewCanvas) {

        var wWidth = wViewCanvas.parentNode.offsetWidth;
        var wHeight = wViewCanvas.parentNode.offsetHeight;

        wViewCanvas.width = wWidth;
        wViewCanvas.height = wHeight;

        gGlobal.HiddenCanvas.width = wWidth;
        gGlobal.HiddenCanvas.height = wHeight;

        var wArraySize = wWidth * wHeight;
        gGlobal.offsetArrayX = new Float32Array(wArraySize);
        gGlobal.offsetArrayY = new Float32Array(wArraySize);
        gGlobal.velocityArrayX = new Float32Array(wArraySize);
        gGlobal.velocityArrayY = new Float32Array(wArraySize);

        for (var wi = 0; wi < wArraySize; ++wi) {
          gGlobal.offsetArrayX[wi] = 0;
          gGlobal.offsetArrayY[wi] = 0;
          gGlobal.velocityArrayX[wi] = 0;
          gGlobal.velocityArrayY[wi] = 0;

        }
      }

    }

    window.addEventListener("load", init);
  </script>
  <style>
    body {
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      margin: 0px;
      padding: 0px;
      background-color: black;
    }

    #id_ViewPoint_div {
      width: 100%;
      height: 100%;
    }

    #id_Input_Img_div {
      position: fixed;
      bottom: 0px;
      background-color: white;
    }
  </style>
</head>

<body>
  <div id="id_Input_Img_div">
    <input type="file" id="id_Input_ImgFile"></input>
    <button id="id_Input_ImgFile_load_btn">Load</button>
  </div>
  <div id="id_ViewPoint_div">
    <canvas id="id_ViewPoint"></canvas>
  </div>
</body>

</html>